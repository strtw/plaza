generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique
  email     String?  @unique // Optional
  firstName String?
  lastName  String?
  phoneHash String   @unique // Hashed phone number for contact matching (HMAC-SHA256)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statuses        Status[]
  invitesCreated  Invite[] @relation("InviteCreator")
  invitesUsed     Invite[] @relation("InviteUser")
  friends         Friend[] @relation("UserFriends")
  friendsAsFriend Friend[] @relation("FriendUser")

  @@index([phoneHash])
}

enum FriendStatus {
  ACTIVE
  MUTED
  BLOCKED
  PENDING
  ACCEPTED
}

model Status {
  id         String             @id @default(uuid())
  userId     String
  status     AvailabilityStatus
  message    String
  location   StatusLocation
  startTime  DateTime
  endTime    DateTime
  sharedWith String[]           @default([]) // Array of user IDs who receive this status
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  acceptedByFriends Friend[] @relation("AcceptedFromStatus")

  @@index([userId])
  @@index([startTime, endTime])
  @@index([sharedWith], type: Gin)
}

enum AvailabilityStatus {
  AVAILABLE // Green
  UNAVAILABLE // Red
}

enum StatusLocation {
  HOME
  GREENSPACE
  THIRD_PLACE
}

model Invite {
  id        String    @id @default(uuid())
  code      String    @unique
  inviterId String
  usedById  String?
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  inviter User  @relation("InviteCreator", fields: [inviterId], references: [id], onDelete: Cascade)
  usedBy  User? @relation("InviteUser", fields: [usedById], references: [id])

  @@index([code])
  @@index([inviterId])
}

model Friend {
  id                   String       @id @default(uuid())
  userId               String // User who added this friend
  friendUserId         String // The Plaza user they added
  status               FriendStatus @default(ACCEPTED)
  acceptedFromStatusId String? // Status ID that triggered acceptance (nullable)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  user               User    @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friendUser         User    @relation("FriendUser", fields: [friendUserId], references: [id], onDelete: Cascade)
  acceptedFromStatus Status? @relation("AcceptedFromStatus", fields: [acceptedFromStatusId], references: [id])

  @@unique([userId, friendUserId])
  @@index([userId])
  @@index([friendUserId])
}
